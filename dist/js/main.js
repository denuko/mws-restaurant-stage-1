'use strict';

var restaurants = void 0;
var neighborhoods = [];
var cuisines = [];
var map;
var markers = [];

/**
 * Fetch neighborhoods and cuisines as soon as the page is loaded.
 */
document.addEventListener('DOMContentLoaded', function (event) {});

/**
 * Set neighborhoods HTML.
 */
var fillNeighborhoodsHTML = function fillNeighborhoodsHTML() {
    var neighborhoods = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.neighborhoods;

    var select = document.getElementById('neighborhoods-select');
    neighborhoods.forEach(function (neighborhood) {
        var option = document.createElement('option');
        option.innerHTML = neighborhood;
        option.value = neighborhood;
        select.append(option);
    });
};

/**
 * Set cuisines HTML.
 */
var fillCuisinesHTML = function fillCuisinesHTML() {
    var cuisines = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.cuisines;

    var select = document.getElementById('cuisines-select');

    cuisines.forEach(function (cuisine) {
        var option = document.createElement('option');
        option.innerHTML = cuisine;
        option.value = cuisine;
        select.append(option);
    });
};

/**
 * Initialize Google map, called from HTML.
 */
window.initMap = function () {
    var loc = {
        lat: 40.722216,
        lng: -73.987501
    };
    self.map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: loc,
        scrollwheel: false
    });
    updateRestaurants();
};

/**
 * Update page and map for current restaurants.
 */
var updateRestaurants = function updateRestaurants() {
    var cSelect = document.getElementById('cuisines-select');
    var nSelect = document.getElementById('neighborhoods-select');

    var cIndex = cSelect.selectedIndex;
    var nIndex = nSelect.selectedIndex;

    var cuisine = cSelect[cIndex].value;
    var neighborhood = nSelect[nIndex].value;

    DBHelper.fetchRestaurantByCuisineAndNeighborhood(cuisine, neighborhood, function (error, restaurants) {
        if (error) {
            // Got an error!
            console.error(error);
        } else {
            resetRestaurants(restaurants);
            fillRestaurantsHTML();
        }
    });
};

/**
 * Clear current restaurants, their HTML and remove their map markers.
 */
var resetRestaurants = function resetRestaurants(restaurants) {
    // Remove all restaurants
    self.restaurants = [];
    var ul = document.getElementById('restaurants-list');
    ul.innerHTML = '';

    // Remove all map markers
    self.markers.forEach(function (m) {
        return m.setMap(null);
    });
    self.markers = [];
    self.restaurants = restaurants;
};

/**
 * Create all restaurants HTML and add them to the webpage.
 */
var fillRestaurantsHTML = function fillRestaurantsHTML() {
    var restaurants = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurants;

    var ul = document.getElementById('restaurants-list');
    restaurants.forEach(function (restaurant) {
        if (DBHelper.addRestaurants()) {
            DBHelper.addRestaurantToDatabase(restaurant);
        }
        ul.append(createRestaurantHTML(restaurant));

        if (!self.neighborhoods.includes(restaurant.neighborhood)) {
            self.neighborhoods.push(restaurant.neighborhood);
        }

        if (!self.cuisines.includes(restaurant.cuisine_type)) {
            self.cuisines.push(restaurant.cuisine_type);
        }
    });

    fillNeighborhoodsHTML();
    fillCuisinesHTML();
    addMarkersToMap();
};

/**
 * Create restaurant HTML.
 */
var createRestaurantHTML = function createRestaurantHTML(restaurant) {
    var li = document.createElement('li');

    // create picture element for restaurant image in restaurant list
    var picture = document.createElement('picture');
    var image = document.createElement('img');
    image.className = 'restaurant-img';
    image.alt = restaurant.name;

    var imageFilename = DBHelper.imageUrlForRestaurant(restaurant);
    if (imageFilename == 'noimg') {
        // If restaurant has not an image, display a no image svg
        // and use its corresponding png as a fallback.
        // Author of the noimg.svg and noimg.png is credited at page's footer.
        var noImgFallback = imageFilename + '.png';
        addImageSourceToPicture(picture, imageFilename + '.svg');
        addImageSourceToPicture(picture, noImgFallback);

        image.src = noImgFallback;
        image.className += ' noimg';
        // TODO: Fix noimg svg responsive height
        // TODO: Fix noimg png fallback in IE
        // TODO: Cache noimg svg and png
    } else {
        // get all possible names of an image depending on its size (small, medium, large)
        var imagesResized = imageNamesBySize(imageFilename);
        // add source to picture element for medium screens
        addImageSourceToPicture(picture, imagesResized.medium, '(min-width: 363px) and (max-width:479px)');

        image.src = imagesResized.small; // small image by default
    }

    picture.append(image);
    li.append(picture);

    var name = document.createElement('h3');
    li.append(name);

    var more = document.createElement('a');
    more.href = DBHelper.urlForRestaurant(restaurant);
    more.innerHTML = restaurant.name;
    more.tabIndex = 0;
    name.append(more);

    var neighborhood = document.createElement('p');
    neighborhood.innerHTML = restaurant.neighborhood;
    li.append(neighborhood);

    var address = document.createElement('p');
    address.innerHTML = restaurant.address;
    li.append(address);

    return li;
};

/**
 * Add markers for current restaurants to the map.
 */
var addMarkersToMap = function addMarkersToMap() {
    var restaurants = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurants;

    restaurants.forEach(function (restaurant) {
        // Add marker to the map
        var marker = DBHelper.mapMarkerForRestaurant(restaurant, self.map);
        google.maps.event.addListener(marker, 'click', function () {
            window.location.href = marker.url;
        });
        self.markers.push(marker);
    });
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsicmVzdGF1cmFudHMiLCJuZWlnaGJvcmhvb2RzIiwiY3Vpc2luZXMiLCJtYXAiLCJtYXJrZXJzIiwiZG9jdW1lbnQiLCJhZGRFdmVudExpc3RlbmVyIiwiZXZlbnQiLCJmaWxsTmVpZ2hib3Job29kc0hUTUwiLCJzZWxmIiwic2VsZWN0IiwiZ2V0RWxlbWVudEJ5SWQiLCJmb3JFYWNoIiwib3B0aW9uIiwiY3JlYXRlRWxlbWVudCIsImlubmVySFRNTCIsIm5laWdoYm9yaG9vZCIsInZhbHVlIiwiYXBwZW5kIiwiZmlsbEN1aXNpbmVzSFRNTCIsImN1aXNpbmUiLCJ3aW5kb3ciLCJpbml0TWFwIiwibG9jIiwibGF0IiwibG5nIiwiZ29vZ2xlIiwibWFwcyIsIk1hcCIsInpvb20iLCJjZW50ZXIiLCJzY3JvbGx3aGVlbCIsInVwZGF0ZVJlc3RhdXJhbnRzIiwiY1NlbGVjdCIsIm5TZWxlY3QiLCJjSW5kZXgiLCJzZWxlY3RlZEluZGV4IiwibkluZGV4IiwiREJIZWxwZXIiLCJmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QiLCJlcnJvciIsImNvbnNvbGUiLCJyZXNldFJlc3RhdXJhbnRzIiwiZmlsbFJlc3RhdXJhbnRzSFRNTCIsInVsIiwibSIsInNldE1hcCIsImFkZFJlc3RhdXJhbnRzIiwiYWRkUmVzdGF1cmFudFRvRGF0YWJhc2UiLCJyZXN0YXVyYW50IiwiY3JlYXRlUmVzdGF1cmFudEhUTUwiLCJpbmNsdWRlcyIsInB1c2giLCJjdWlzaW5lX3R5cGUiLCJhZGRNYXJrZXJzVG9NYXAiLCJsaSIsInBpY3R1cmUiLCJpbWFnZSIsImNsYXNzTmFtZSIsImFsdCIsIm5hbWUiLCJpbWFnZUZpbGVuYW1lIiwiaW1hZ2VVcmxGb3JSZXN0YXVyYW50Iiwibm9JbWdGYWxsYmFjayIsImFkZEltYWdlU291cmNlVG9QaWN0dXJlIiwic3JjIiwiaW1hZ2VzUmVzaXplZCIsImltYWdlTmFtZXNCeVNpemUiLCJtZWRpdW0iLCJzbWFsbCIsIm1vcmUiLCJocmVmIiwidXJsRm9yUmVzdGF1cmFudCIsInRhYkluZGV4IiwiYWRkcmVzcyIsIm1hcmtlciIsIm1hcE1hcmtlckZvclJlc3RhdXJhbnQiLCJhZGRMaXN0ZW5lciIsImxvY2F0aW9uIiwidXJsIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUlBLG9CQUFKO0FBQ0EsSUFBSUMsZ0JBQWdCLEVBQXBCO0FBQ0EsSUFBSUMsV0FBVyxFQUFmO0FBQ0EsSUFBSUMsR0FBSjtBQUNBLElBQUlDLFVBQVUsRUFBZDs7QUFFQTs7O0FBR0FDLFNBQVNDLGdCQUFULENBQTBCLGtCQUExQixFQUE4QyxVQUFDQyxLQUFELEVBQVcsQ0FDeEQsQ0FERDs7QUFHQTs7O0FBR0EsSUFBTUMsd0JBQXdCLFNBQXhCQSxxQkFBd0IsR0FBd0M7QUFBQSxRQUF2Q1AsYUFBdUMsdUVBQXZCUSxLQUFLUixhQUFrQjs7QUFDbEUsUUFBTVMsU0FBU0wsU0FBU00sY0FBVCxDQUF3QixzQkFBeEIsQ0FBZjtBQUNBVixrQkFBY1csT0FBZCxDQUFzQix3QkFBZ0I7QUFDbEMsWUFBTUMsU0FBU1IsU0FBU1MsYUFBVCxDQUF1QixRQUF2QixDQUFmO0FBQ0FELGVBQU9FLFNBQVAsR0FBbUJDLFlBQW5CO0FBQ0FILGVBQU9JLEtBQVAsR0FBZUQsWUFBZjtBQUNBTixlQUFPUSxNQUFQLENBQWNMLE1BQWQ7QUFDSCxLQUxEO0FBTUgsQ0FSRDs7QUFVQTs7O0FBR0EsSUFBTU0sbUJBQW1CLFNBQW5CQSxnQkFBbUIsR0FBOEI7QUFBQSxRQUE3QmpCLFFBQTZCLHVFQUFsQk8sS0FBS1AsUUFBYTs7QUFDbkQsUUFBTVEsU0FBU0wsU0FBU00sY0FBVCxDQUF3QixpQkFBeEIsQ0FBZjs7QUFFQVQsYUFBU1UsT0FBVCxDQUFpQixtQkFBVztBQUN4QixZQUFNQyxTQUFTUixTQUFTUyxhQUFULENBQXVCLFFBQXZCLENBQWY7QUFDQUQsZUFBT0UsU0FBUCxHQUFtQkssT0FBbkI7QUFDQVAsZUFBT0ksS0FBUCxHQUFlRyxPQUFm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LFNBQUwsR0FBaUJrQyxXQUFXVyxJQUE1QjtBQUNBVSxTQUFLRyxRQUFMLEdBQWdCLENBQWhCO0FBQ0FiLFNBQUsxQyxNQUFMLENBQVlvRCxJQUFaOztBQUVBLFFBQU10RCxlQUFlWCxTQUFTUyxhQUFULENBQXVCLEdBQXZCLENBQXJCO0FBQ0FFLGlCQUFhRCxTQUFiLEdBQXlCa0MsV0FBV2pDLFlBQXBDO0FBQ0F1QyxPQUFHckMsTUFBSCxDQUFVRixZQUFWOztBQUVBLFFBQU0wRCxVQUFVckUsU0FBU1MsYUFBVCxDQUF1QixHQUF2QixDQUFoQjtBQUNBNEQsWUFBUTNELFNBQVIsR0FBb0JrQyxXQUFXeUIsT0FBL0I7QUFDQW5CLE9BQUdyQyxNQUFILENBQVV3RCxPQUFWOztBQUVBLFdBQU9uQixFQUFQO0FBQ0gsQ0FyREQ7O0FBdURBOzs7QUFHQSxJQUFNRCxrQkFBa0IsU0FBbEJBLGVBQWtCLEdBQW9DO0FBQUEsUUFBbkN0RCxXQUFtQyx1RUFBckJTLEtBQUtULFdBQWdCOztBQUN4REEsZ0JBQVlZLE9BQVosQ0FBb0Isc0JBQWM7QUFDOUI7QUFDQSxZQUFNK0QsU0FBU3JDLFNBQVNzQyxzQkFBVCxDQUFnQzNCLFVBQWhDLEVBQTRDeEMsS0FBS04sR0FBakQsQ0FBZjtBQUNBdUIsZUFBT0MsSUFBUCxDQUFZcEIsS0FBWixDQUFrQnNFLFdBQWxCLENBQThCRixNQUE5QixFQUFzQyxPQUF0QyxFQUErQyxZQUFNO0FBQ2pEdEQsbUJBQU95RCxRQUFQLENBQWdCUCxJQUFoQixHQUF1QkksT0FBT0ksR0FBOUI7QUFDSCxTQUZEO0FBR0F0RSxhQUFLTCxPQUFMLENBQWFnRCxJQUFiLENBQWtCdUIsTUFBbEI7QUFDSCxLQVBEO0FBUUgsQ0FURCIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsibGV0IHJlc3RhdXJhbnRzO1xyXG5sZXQgbmVpZ2hib3Job29kcyA9IFtdO1xyXG5sZXQgY3Vpc2luZXMgPSBbXTtcclxudmFyIG1hcFxyXG52YXIgbWFya2VycyA9IFtdXHJcblxyXG4vKipcclxuICogRmV0Y2ggbmVpZ2hib3Job29kcyBhbmQgY3Vpc2luZXMgYXMgc29vbiBhcyB0aGUgcGFnZSBpcyBsb2FkZWQuXHJcbiAqL1xyXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgKGV2ZW50KSA9PiB7XHJcbn0pO1xyXG5cclxuLyoqXHJcbiAqIFNldCBuZWlnaGJvcmhvb2RzIEhUTUwuXHJcbiAqL1xyXG5jb25zdCBmaWxsTmVpZ2hib3Job29kc0hUTUwgPSAobmVpZ2hib3Job29kcyA9IHNlbGYubmVpZ2hib3Job29kcykgPT4ge1xyXG4gICAgY29uc3Qgc2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25laWdoYm9yaG9vZHMtc2VsZWN0Jyk7XHJcbiAgICBuZWlnaGJvcmhvb2RzLmZvckVhY2gobmVpZ2hib3Job29kID0+IHtcclxuICAgICAgICBjb25zdCBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKTtcclxuICAgICAgICBvcHRpb24uaW5uZXJIVE1MID0gbmVpZ2hib3Job29kO1xyXG4gICAgICAgIG9wdGlvbi52YWx1ZSA9IG5laWdoYm9yaG9vZDtcclxuICAgICAgICBzZWxlY3QuYXBwZW5kKG9wdGlvbik7XHJcbiAgICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFNldCBjdWlzaW5lcyBIVE1MLlxyXG4gKi9cclxuY29uc3QgZmlsbEN1aXNpbmVzSFRNTCA9IChjdWlzaW5lcyA9IHNlbGYuY3Vpc2luZXMpID0+IHtcclxuICAgIGNvbnN0IHNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdWlzaW5lcy1zZWxlY3QnKTtcclxuXHJcbiAgICBjdWlzaW5lcy5mb3JFYWNoKGN1aXNpbmUgPT4ge1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xyXG4gICAgICAgIG9wdGlvbi5pbm5lckhUTUwgPSBjdWlzaW5lO1xyXG4gICAgICAgIG9wdGlvbi52YWx1ZSA9IGN1aXNpbmU7XHJcbiAgICAgICAgc2VsZWN0LmFwcGVuZChvcHRpb24pO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBJbml0aWFsaXplIEdvb2dsZSBtYXAsIGNhbGxlZCBmcm9tIEhUTUwuXHJcbiAqL1xyXG53aW5kb3cuaW5pdE1hcCA9ICgpID0+IHtcclxuICAgIGxldCBsb2MgPSB7XHJcbiAgICAgICAgbGF0OiA0MC43MjIyMTYsXHJcbiAgICAgICAgbG5nOiAtNzMuOTg3NTAxXHJcbiAgICB9O1xyXG4gICAgc2VsZi5tYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAnKSwge1xyXG4gICAgICAgIHpvb206IDEyLFxyXG4gICAgICAgIGNlbnRlcjogbG9jLFxyXG4gICAgICAgIHNjcm9sbHdoZWVsOiBmYWxzZVxyXG4gICAgfSk7XHJcbiAgICB1cGRhdGVSZXN0YXVyYW50cygpO1xyXG59XHJcblxyXG4vKipcclxuICogVXBkYXRlIHBhZ2UgYW5kIG1hcCBmb3IgY3VycmVudCByZXN0YXVyYW50cy5cclxuICovXHJcbmNvbnN0IHVwZGF0ZVJlc3RhdXJhbnRzID0gKCkgPT4ge1xyXG4gICAgY29uc3QgY1NlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdWlzaW5lcy1zZWxlY3QnKTtcclxuICAgIGNvbnN0IG5TZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmVpZ2hib3Job29kcy1zZWxlY3QnKTtcclxuXHJcbiAgICBjb25zdCBjSW5kZXggPSBjU2VsZWN0LnNlbGVjdGVkSW5kZXg7XHJcbiAgICBjb25zdCBuSW5kZXggPSBuU2VsZWN0LnNlbGVjdGVkSW5kZXg7XHJcblxyXG4gICAgY29uc3QgY3Vpc2luZSA9IGNTZWxlY3RbY0luZGV4XS52YWx1ZTtcclxuICAgIGNvbnN0IG5laWdoYm9yaG9vZCA9IG5TZWxlY3RbbkluZGV4XS52YWx1ZTtcclxuXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kLCAoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgICAgaWYgKGVycm9yKSB7IC8vIEdvdCBhbiBlcnJvciFcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVzZXRSZXN0YXVyYW50cyhyZXN0YXVyYW50cyk7XHJcbiAgICAgICAgICAgIGZpbGxSZXN0YXVyYW50c0hUTUwoKTtcclxuICAgICAgICB9XHJcbiAgICB9KVxyXG59XHJcblxyXG4vKipcclxuICogQ2xlYXIgY3VycmVudCByZXN0YXVyYW50cywgdGhlaXIgSFRNTCBhbmQgcmVtb3ZlIHRoZWlyIG1hcCBtYXJrZXJzLlxyXG4gKi9cclxuY29uc3QgcmVzZXRSZXN0YXVyYW50cyA9IChyZXN0YXVyYW50cykgPT4ge1xyXG4gICAgLy8gUmVtb3ZlIGFsbCByZXN0YXVyYW50c1xyXG4gICAgc2VsZi5yZXN0YXVyYW50cyA9IFtdO1xyXG4gICAgY29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudHMtbGlzdCcpO1xyXG4gICAgdWwuaW5uZXJIVE1MID0gJyc7XHJcblxyXG4gICAgLy8gUmVtb3ZlIGFsbCBtYXAgbWFya2Vyc1xyXG4gICAgc2VsZi5tYXJrZXJzLmZvckVhY2gobSA9PiBtLnNldE1hcChudWxsKSk7XHJcbiAgICBzZWxmLm1hcmtlcnMgPSBbXTtcclxuICAgIHNlbGYucmVzdGF1cmFudHMgPSByZXN0YXVyYW50cztcclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSBhbGwgcmVzdGF1cmFudHMgSFRNTCBhbmQgYWRkIHRoZW0gdG8gdGhlIHdlYnBhZ2UuXHJcbiAqL1xyXG5jb25zdCBmaWxsUmVzdGF1cmFudHNIVE1MID0gKHJlc3RhdXJhbnRzID0gc2VsZi5yZXN0YXVyYW50cykgPT4ge1xyXG4gICAgY29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudHMtbGlzdCcpO1xyXG4gICAgcmVzdGF1cmFudHMuZm9yRWFjaChyZXN0YXVyYW50ID0+IHtcclxuICAgICAgICBpZiAoREJIZWxwZXIuYWRkUmVzdGF1cmFudHMoKSkge1xyXG4gICAgICAgICAgICBEQkhlbHBlci5hZGRSZXN0YXVyYW50VG9EYXRhYmFzZShyZXN0YXVyYW50KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdWwuYXBwZW5kKGNyZWF0ZVJlc3RhdXJhbnRIVE1MKHJlc3RhdXJhbnQpKTtcclxuXHJcbiAgICAgICAgaWYgKCFzZWxmLm5laWdoYm9yaG9vZHMuaW5jbHVkZXMocmVzdGF1cmFudC5uZWlnaGJvcmhvb2QpKSB7XHJcbiAgICAgICAgICAgIHNlbGYubmVpZ2hib3Job29kcy5wdXNoKHJlc3RhdXJhbnQubmVpZ2hib3Job29kKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghc2VsZi5jdWlzaW5lcy5pbmNsdWRlcyhyZXN0YXVyYW50LmN1aXNpbmVfdHlwZSkpIHtcclxuICAgICAgICAgICAgc2VsZi5jdWlzaW5lcy5wdXNoKHJlc3RhdXJhbnQuY3Vpc2luZV90eXBlKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBmaWxsTmVpZ2hib3Job29kc0hUTUwoKTtcclxuICAgIGZpbGxDdWlzaW5lc0hUTUwoKTtcclxuICAgIGFkZE1hcmtlcnNUb01hcCgpO1xyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlIHJlc3RhdXJhbnQgSFRNTC5cclxuICovXHJcbmNvbnN0IGNyZWF0ZVJlc3RhdXJhbnRIVE1MID0gKHJlc3RhdXJhbnQpID0+IHtcclxuICAgIGNvbnN0IGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcclxuXHJcbiAgICAvLyBjcmVhdGUgcGljdHVyZSBlbGVtZW50IGZvciByZXN0YXVyYW50IGltYWdlIGluIHJlc3RhdXJhbnQgbGlzdFxyXG4gICAgY29uc3QgcGljdHVyZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3BpY3R1cmUnKTtcclxuICAgIGNvbnN0IGltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7XHJcbiAgICBpbWFnZS5jbGFzc05hbWUgPSAncmVzdGF1cmFudC1pbWcnO1xyXG4gICAgaW1hZ2UuYWx0ID0gcmVzdGF1cmFudC5uYW1lO1xyXG5cclxuICAgIGNvbnN0IGltYWdlRmlsZW5hbWUgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XHJcbiAgICBpZiAoaW1hZ2VGaWxlbmFtZSA9PSAnbm9pbWcnKSB7XHJcbiAgICAgICAgLy8gSWYgcmVzdGF1cmFudCBoYXMgbm90IGFuIGltYWdlLCBkaXNwbGF5IGEgbm8gaW1hZ2Ugc3ZnXHJcbiAgICAgICAgLy8gYW5kIHVzZSBpdHMgY29ycmVzcG9uZGluZyBwbmcgYXMgYSBmYWxsYmFjay5cclxuICAgICAgICAvLyBBdXRob3Igb2YgdGhlIG5vaW1nLnN2ZyBhbmQgbm9pbWcucG5nIGlzIGNyZWRpdGVkIGF0IHBhZ2UncyBmb290ZXIuXHJcbiAgICAgICAgY29uc3Qgbm9JbWdGYWxsYmFjayA9IGAke2ltYWdlRmlsZW5hbWV9LnBuZ2A7XHJcbiAgICAgICAgYWRkSW1hZ2VTb3VyY2VUb1BpY3R1cmUocGljdHVyZSwgYCR7aW1hZ2VGaWxlbmFtZX0uc3ZnYCk7XHJcbiAgICAgICAgYWRkSW1hZ2VTb3VyY2VUb1BpY3R1cmUocGljdHVyZSwgbm9JbWdGYWxsYmFjayk7XHJcblxyXG4gICAgICAgIGltYWdlLnNyYyA9IG5vSW1nRmFsbGJhY2s7XHJcbiAgICAgICAgaW1hZ2UuY2xhc3NOYW1lICs9ICcgbm9pbWcnO1xyXG4gICAgICAgIC8vIFRPRE86IEZpeCBub2ltZyBzdmcgcmVzcG9uc2l2ZSBoZWlnaHRcclxuICAgICAgICAvLyBUT0RPOiBGaXggbm9pbWcgcG5nIGZhbGxiYWNrIGluIElFXHJcbiAgICAgICAgLy8gVE9ETzogQ2FjaGUgbm9pbWcgc3ZnIGFuZCBwbmdcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gZ2V0IGFsbCBwb3NzaWJsZSBuYW1lcyBvZiBhbiBpbWFnZSBkZXBlbmRpbmcgb24gaXRzIHNpemUgKHNtYWxsLCBtZWRpdW0sIGxhcmdlKVxyXG4gICAgICAgIGNvbnN0IGltYWdlc1Jlc2l6ZWQgPSBpbWFnZU5hbWVzQnlTaXplKGltYWdlRmlsZW5hbWUpO1xyXG4gICAgICAgIC8vIGFkZCBzb3VyY2UgdG8gcGljdHVyZSBlbGVtZW50IGZvciBtZWRpdW0gc2NyZWVuc1xyXG4gICAgICAgIGFkZEltYWdlU291cmNlVG9QaWN0dXJlKHBpY3R1cmUsIGltYWdlc1Jlc2l6ZWQubWVkaXVtLCAnKG1pbi13aWR0aDogMzYzcHgpIGFuZCAobWF4LXdpZHRoOjQ3OXB4KScpO1xyXG5cclxuICAgICAgICBpbWFnZS5zcmMgPSBpbWFnZXNSZXNpemVkLnNtYWxsOyAgIC8vIHNtYWxsIGltYWdlIGJ5IGRlZmF1bHRcclxuICAgIH1cclxuXHJcbiAgICBwaWN0dXJlLmFwcGVuZChpbWFnZSk7XHJcbiAgICBsaS5hcHBlbmQocGljdHVyZSk7XHJcblxyXG4gICAgY29uc3QgbmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gzJyk7XHJcbiAgICBsaS5hcHBlbmQobmFtZSk7XHJcblxyXG4gICAgY29uc3QgbW9yZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcclxuICAgIG1vcmUuaHJlZiA9IERCSGVscGVyLnVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XHJcbiAgICBtb3JlLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmFtZTtcclxuICAgIG1vcmUudGFiSW5kZXggPSAwO1xyXG4gICAgbmFtZS5hcHBlbmQobW9yZSk7XHJcblxyXG4gICAgY29uc3QgbmVpZ2hib3Job29kID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgbmVpZ2hib3Job29kLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmVpZ2hib3Job29kO1xyXG4gICAgbGkuYXBwZW5kKG5laWdoYm9yaG9vZCk7XHJcblxyXG4gICAgY29uc3QgYWRkcmVzcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICAgIGFkZHJlc3MuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5hZGRyZXNzO1xyXG4gICAgbGkuYXBwZW5kKGFkZHJlc3MpO1xyXG5cclxuICAgIHJldHVybiBsaVxyXG59XHJcblxyXG4vKipcclxuICogQWRkIG1hcmtlcnMgZm9yIGN1cnJlbnQgcmVzdGF1cmFudHMgdG8gdGhlIG1hcC5cclxuICovXHJcbmNvbnN0IGFkZE1hcmtlcnNUb01hcCA9IChyZXN0YXVyYW50cyA9IHNlbGYucmVzdGF1cmFudHMpID0+IHtcclxuICAgIHJlc3RhdXJhbnRzLmZvckVhY2gocmVzdGF1cmFudCA9PiB7XHJcbiAgICAgICAgLy8gQWRkIG1hcmtlciB0byB0aGUgbWFwXHJcbiAgICAgICAgY29uc3QgbWFya2VyID0gREJIZWxwZXIubWFwTWFya2VyRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBzZWxmLm1hcCk7XHJcbiAgICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIobWFya2VyLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gbWFya2VyLnVybFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNlbGYubWFya2Vycy5wdXNoKG1hcmtlcik7XHJcbiAgICB9KTtcclxufVxyXG4iXX0=

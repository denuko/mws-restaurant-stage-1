'use strict';

var restaurants = void 0;
var neighborhoods = [];
var cuisines = [];
var map;
var markers = [];

/**
 * Fetch restaurants as soon as the page is loaded.
 */
document.addEventListener('DOMContentLoaded', function (event) {
    updateRestaurants();
});

/**
 * Set neighborhoods HTML.
 */
var fillNeighborhoodsHTML = function fillNeighborhoodsHTML() {
    var neighborhoods = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.neighborhoods;

    var select = document.getElementById('neighborhoods-select');
    neighborhoods.forEach(function (neighborhood) {
        var option = document.createElement('option');
        option.innerHTML = neighborhood;
        option.value = neighborhood;
        select.append(option);
    });
};

/**
 * Set cuisines HTML.
 */
var fillCuisinesHTML = function fillCuisinesHTML() {
    var cuisines = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.cuisines;

    var select = document.getElementById('cuisines-select');

    cuisines.forEach(function (cuisine) {
        var option = document.createElement('option');
        option.innerHTML = cuisine;
        option.value = cuisine;
        select.append(option);
    });
};

/**
 * Initialize Google map, called from HTML.
 */
window.initMap = function () {
    var loc = {
        lat: 40.722216,
        lng: -73.987501
    };
    self.map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: loc,
        scrollwheel: false
    });

    // Add markers to the map after being initialized
    addMarkersToMap();
};

/**
 * Update page and map for current restaurants.
 */
var updateRestaurants = function updateRestaurants() {
    var cSelect = document.getElementById('cuisines-select');
    var nSelect = document.getElementById('neighborhoods-select');

    var cIndex = cSelect.selectedIndex;
    var nIndex = nSelect.selectedIndex;

    var cuisine = cSelect[cIndex].value;
    var neighborhood = nSelect[nIndex].value;

    DBHelper.fetchRestaurantByCuisineAndNeighborhood(cuisine, neighborhood, function (error, restaurants) {
        if (error) {
            // Got an error!
            console.error(error);
        } else {
            resetRestaurants(restaurants);
            fillRestaurantsHTML();

            // Include maps api dynamically only after everything else has been done
            getGoogleMapsApi();
        }
    });
};

/**
 * Clear current restaurants, their HTML and remove their map markers.
 */
var resetRestaurants = function resetRestaurants(restaurants) {
    // Remove all restaurants
    self.restaurants = [];
    var ul = document.getElementById('restaurants-list');
    ul.innerHTML = '';

    // Remove all map markers
    self.markers.forEach(function (m) {
        return m.setMap(null);
    });
    self.markers = [];
    self.restaurants = restaurants;
};

/**
 * Create all restaurants HTML and add them to the webpage.
 */
var fillRestaurantsHTML = function fillRestaurantsHTML() {
    var restaurants = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurants;

    var ul = document.getElementById('restaurants-list');
    restaurants.forEach(function (restaurant) {
        if (DBHelper.addRestaurants()) {
            DBHelper.addRestaurantToDatabase(restaurant);
        }
        ul.append(createRestaurantHTML(restaurant));

        if (!self.neighborhoods.includes(restaurant.neighborhood)) {
            self.neighborhoods.push(restaurant.neighborhood);
        }

        if (!self.cuisines.includes(restaurant.cuisine_type)) {
            self.cuisines.push(restaurant.cuisine_type);
        }
    });

    fillNeighborhoodsHTML();
    fillCuisinesHTML();
};

/**
 * Create restaurant HTML.
 */
var createRestaurantHTML = function createRestaurantHTML(restaurant) {
    var li = document.createElement('li');

    // create picture element for restaurant image in restaurant list
    var picture = document.createElement('picture');
    var image = document.createElement('img');
    image.className = 'restaurant-img';
    image.alt = restaurant.name;

    var imageFilename = DBHelper.imageUrlForRestaurant(restaurant);
    if (imageFilename == 'noimg') {
        // If restaurant has not an image, display a no image svg
        // and use its corresponding png as a fallback.
        // Author of the noimg.svg and noimg.png is credited at page's footer.
        var noImgFallback = imageFilename + '.png';
        addImageSourceToPicture(picture, imageFilename + '.svg');
        addImageSourceToPicture(picture, noImgFallback);

        image.src = noImgFallback;
        image.className += ' noimg';
        // TODO: Fix noimg svg responsive height
        // TODO: Fix noimg png fallback in IE
        // TODO: Cache noimg svg and png
    } else {
        // get all possible names of an image depending on its size (small, medium, large)
        var imagesResized = imageNamesBySize(imageFilename);
        // add source to picture element for medium screens
        addImageSourceToPicture(picture, imagesResized.medium, '(min-width: 363px) and (max-width:479px)');

        image.src = imagesResized.small; // small image by default
    }

    picture.append(image);
    li.append(picture);

    var name = document.createElement('h3');
    li.append(name);

    var more = document.createElement('a');
    more.href = DBHelper.urlForRestaurant(restaurant);
    more.innerHTML = restaurant.name;
    more.tabIndex = 0;
    name.append(more);

    var neighborhood = document.createElement('p');
    neighborhood.innerHTML = restaurant.neighborhood;
    li.append(neighborhood);

    var address = document.createElement('p');
    address.innerHTML = restaurant.address;
    li.append(address);

    return li;
};

/**
 * Add markers for current restaurants to the map.
 */
var addMarkersToMap = function addMarkersToMap() {
    var restaurants = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurants;

    restaurants.forEach(function (restaurant) {
        // Add marker to the map
        var marker = DBHelper.mapMarkerForRestaurant(restaurant, self.map);
        google.maps.event.addListener(marker, 'click', function () {
            window.location.href = marker.url;
        });
        self.markers.push(marker);
    });
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsicmVzdGF1cmFudHMiLCJuZWlnaGJvcmhvb2RzIiwiY3Vpc2luZXMiLCJtYXAiLCJtYXJrZXJzIiwiZG9jdW1lbnQiLCJhZGRFdmVudExpc3RlbmVyIiwiZXZlbnQiLCJ1cGRhdGVSZXN0YXVyYW50cyIsImZpbGxOZWlnaGJvcmhvb2RzSFRNTCIsInNlbGYiLCJzZWxlY3QiLCJnZXRFbGVtZW50QnlJZCIsImZvckVhY2giLCJvcHRpb24iLCJjcmVhdGVFbGVtZW50IiwiaW5uZXJIVE1MIiwibmVpZ2hib3Job29kIiwidmFsdWUiLCJhcHBlbmQiLCJmaWxsQ3Vpc2luZXNIVE1MIiwiY3Vpc2luZSIsIndpbmRvdyIsImluaXRNYXAiLCJsb2MiLCJsYXQiLCJsbmciLCJnb29nbGUiLCJtYXBzIiwiTWFwIiwiem9vbSIsImNlbnRlciIsInNjcm9sbHdoZWVsIiwiYWRkTWFya2Vyc1RvTWFwIiwiY1NlbGVjdCIsIm5TZWxlY3QiLCJjSW5kZXgiLCJzZWxlY3RlZEluZGV4IiwibkluZGV4IiwiREJIZWxwZXIiLCJmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QiLCJlcnJvciIsImNvbnNvbGUiLCJyZXNldFJlc3RhdXJhbnRzIiwiZmlsbFJlc3RhdXJhbnRzSFRNTCIsImdldEdvb2dsZU1hcHNBcGkiLCJ1bCIsIm0iLCJzZXRNYXAiLCJhZGRSZXN0YXVyYW50cyIsImFkZFJlc3RhdXJhbnRUb0RhdGFiYXNlIiwicmVzdGF1cmFudCIsImNyZWF0ZVJlc3RhdXJhbnRIVE1MIiwiaW5jbHVkZXMiLCJwdXNoIiwiY3Vpc2luZV90eXBlIiwibGkiLCJwaWN0dXJlIiwiaW1hZ2UiLCJjbGFzc05hbWUiLCJhbHQiLCJuYW1lIiwiaW1hZ2VGaWxlbmFtZSIsImltYWdlVXJsRm9yUmVzdGF1cmFudCIsIm5vSW1nRmFsbGJhY2siLCJhZGRJbWFnZVNvdXJjZVRvUGljdHVyZSIsInNyYyIsImltYWdlc1Jlc2l6ZWQiLCJpbWFnZU5hbWVzQnlTaXplIiwibWVkaXVtIiwic21hbGwiLCJtb3JlIiwiaHJlZiIsInVybEZvclJlc3RhdXJhbnQiLCJ0YWJJbmRleCIsImFkZHJlc3MiLCJtYXJrZXIiLCJtYXBNYXJrZXJGb3JSZXN0YXVyYW50IiwiYWRkTGlzdGVuZXIiLCJsb2NhdGlvbiIsInVybCJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJQSxvQkFBSjtBQUNBLElBQUlDLGdCQUFnQixFQUFwQjtBQUNBLElBQUlDLFdBQVcsRUFBZjtBQUNBLElBQUlDLEdBQUo7QUFDQSxJQUFJQyxVQUFVLEVBQWQ7O0FBRUE7OztBQUdBQyxTQUFTQyxnQkFBVCxDQUEwQixrQkFBMUIsRUFBOEMsVUFBQ0MsS0FBRCxFQUFXO0FBQ3JEQztBQUNILENBRkQ7O0FBSUE7OztBQUdBLElBQU1DLHdCQUF3QixTQUF4QkEscUJBQXdCLEdBQXdDO0FBQUEsUUFBdkNSLGFBQXVDLHVFQUF2QlMsS0FBS1QsYUFBa0I7O0FBQ2xFLFFBQU1VLFNBQVNOLFNBQVNPLGNBQVQsQ0FBd0Isc0JBQXhCLENBQWY7QUFDQVgsa0JBQWNZLE9BQWQsQ0FBc0Isd0JBQWdCO0FBQ2xDLFlBQU1DLFNBQVNULFNBQVNVLGFBQVQsQ0FBdUIsUUFBdkIsQ0FBZjtBQUNBRCxlQUFPRSxTQUFQLEdBQW1CQyxZQUFuQjtBQUNBSCxlQUFPSSxLQUFQLEdBQWVELFlBQWY7QUFDQU4sZUFBT1EsTUFBUCxDQUFjTCxNQUFkO0FBQ0gsS0FMRDtBQU1ILENBUkQ7O0FBVUE7OztBQUdBLElBQU1NLG1CQUFtQixTQUFuQkEsZ0JBQW1CLEdBQThCO0FBQUEsUUFBN0JsQixRQUE2Qix1RUFBbEJRLEtBQUtSLFFBQWE7O0FBQ25ELFFBQU1TLFNBQVNOLFNBQVNPLGNBQVQsQ0FBd0IsaUJBQXhCLENBQWY7O0FBRUFWLGFBQVNXLE9BQVQsQ0FBaUIsbUJBQVc7QUFDeEIsWUFBTUMsU0FBU1QsU0FBU1UsYUFBVCxDQUF1QixRQUF2QixDQUFmO0FBQ0FELGVBQU9FLFNBQVAsR0FBbUJLLE9BQW5CO0FBQ0FQLGVBQU9JLEtBQVAsR0FBZUcsT0FBZjtBQUNBVixlQUFPUSxNQUFQLENBQWNMLE1BQWQ7QUFDSCxLQUxEO0FBTUgsQ0FURDs7QUFXQTs7O0FBR0FRLE9BQU9DLE9BQVAsR0FBaUIsWUFBTTtBQUNuQixRQUFJQyxNQUFNO0FBQ05DLGFBQUssU0FEQztBQUVOQyxhQUFLLENBQUM7QUFGQSxLQUFWO0FBSUFoQixTQUFLUCxHQUFMLEdBQVcsSUFBSXdCLE9BQU9DLElBQVAsQ0FBWUMsR0FBaEIsQ0FBb0J4QixTQUFTTyxjQUFULENBQXdCLEtBQXhCLENBQXBCLEVBQW9EO0FBQzNEa0IsY0FBTSxFQURxRDtBQUUzREMsZ0JBQVFQLEdBRm1EO0FBRzNEUSxxQkFBYTtBQUg4QyxLQUFwRCxDQUFYOztBQU1BO0FBQ0FDO0FBQ0gsQ0FiRDs7QUFlQTs7O0FBR0EsSUFBTXpCLG9CQUFvQixTQUFwQkEsaUJBQW9CLEdBQU07QUFDNUIsUUFBTTBCLFVBQVU3QixTQUFTTyxjQUFULENBQXdCLGlCQUF4QixDQUFoQjtBQUNBLFFBQU11QixVQUFVOUIsU0FBU08sY0FBVCxDQUF3QixzQkFBeEIsQ0FBaEI7O0FBRUEsUUFBTXdCLFNBQVNGLFFBQVFHLGFBQXZCO0FBQ0EsUUFBTUMsU0FBU0gsUUFBUUUsYUFBdkI7O0FBRUEsUUFBTWhCLFVBQVVhLFFBQVFFLE1BQVIsRUFBZ0JsQixLQUFoQztBQUNBLFFBQU1ELGVBQWVrQixRQUFRRyxNQUFSLEVBQWdCcEIsS0FBckM7O0FBRUFxQixhQUFTQyx1Q0FBVCxDQUFpRG5CLE9BQWpELEVBQTBESixZQUExRCxFQUF3RSxVQUFDd0IsS0FBRCxFQUFRekMsV0FBUixFQUF3QjtBQUM1RixZQUFJeUMsS0FBSixFQUFXO0FBQUU7QUFDVEMsb0JBQVFELEtBQVIsQ0FBY0EsS0FBZDtBQUNILFNBRkQsTUFFTztBQUNIRSw2QkFBaUIzQyxXQUFqQjtBQUNBNEM7O0FBRUE7QUFDQUM7QUFDSDtBQUNKLEtBVkQ7QUFXSCxDQXJCRDs7QUF1QkE7OztBQUdBLElBQU1GLG1CQUFtQixTQUFuQkEsZ0JBQW1CLENBQUMzQyxXQUFELEVBQWlCO0FBQ3RDO0FBQ0FVLFNBQUtWLFdBQUwsR0FBbUIsRUFBbkI7QUFDQSxRQUFNOEMsS0FBS3pDLFNBQVNPLGNBQVQsQ0FBd0Isa0JBQXhCLENBQVg7QUFDQWtDLE9BQUc5QixTQUFILEdBQWUsRUFBZjs7QUFFQTtBQUNBTixTQUFLTixPQUFMLENBQWFTLE9BQWIsQ0FBcUI7QUFBQSxlQUFLa0MsRUFBRUMsTUFBRixDQUFTLElBQVQsQ0FBTDtBQUFBLEtBQXJCO0FBQ0F0QyxTQUFLTixPQUFMLEdBQWUsRUFBZjtBQUNBTSxTQUFLVixXQUFMLEdBQW1CQSxXQUFuQjtBQUNILENBVkQ7O0FBWUE7OztBQUdBLElBQU00QyxzQkFBc0IsU0FBdEJBLG1CQUFzQixHQUFvQztBQUFBLFFBQW5DNUMsV0FBbUMsdUVBQXJCVSxLQUFLVixXQUFnQjs7QUFDNUQsUUFBTThDLEtBQUt6QyxTQUFTTyxjQUFULENBQXdCLGtCQUF4QixDQUFYO0FBQ0FaLGdCQUFZYSxPQUFaLENBQW9CLHNCQUFjO0FBQzlCLFlBQUkwQixTQUFTVSxjQUFULEVBQUosRUFBK0I7QUFDM0JWLHFCQUFTVyx1QkFBVCxDQUFpQ0MsVUFBakM7QUFDSDtBQUNETCxXQUFHM0IsTUFBSCxDQUFVaUMscUJBQXFCRCxVQUFyQixDQUFWOztBQUVBLFlBQUksQ0FBQ3pDLEtBQUtULGFBQUwsQ0FBbUJvRCxRQUFuQixDQUE0QkYsV0FBV2xDLFlBQXZDLENBQUwsRUFBMkQ7QUFDdkRQLGlCQUFLVCxhQUFMLENBQW1CcUQsSUFBbkIsQ0FBd0JILFdBQVdsQyxZQUFuQztBQUNIOztBQUVELFlBQUksQ0FBQ1AsS0FBS1IsUUFBTCxDQUFjbUQsUUFBZCxDQUF1QkYsV0FBV0ksWUFBbEMsQ0FBTCxFQUFzRDtBQUNsRDdDLGlCQUFLUixRQUFMLENBQWNvRCxJQUFkLENBQW1CSCxXQUFXSSxZQUE5QjtBQUNIO0FBQ0osS0FiRDs7QUFlQTlDO0FBQ0FXO0FBQ0gsQ0FuQkQ7O0FBcUJBOzs7QUFHQSxJQUFNZ0MsdUJBQXVCLFNBQXZCQSxvQkFBdUIsQ0FBQ0QsVUFBRCxFQUFnQjtBQUN6QyxRQUFNSyxLQUFLbkQsU0FBU1UsYUFBVCxDQUF1QixJQUF2QixDQUFYOztBQUVBO0FBQ0EsUUFBTTBDLFVBQVVwRCxTQUFTVSxhQUFULENBQXVCLFNBQXZCLENBQWhCO0FBQ0EsUUFBTTJDLFFBQVFyRCxTQUFTVSxhQUFULENBQXVCLEtBQXZCLENBQWQ7QUFDQTJDLFVBQU1DLFNBQU4sR0FBa0IsZ0JBQWxCO0FBQ0FELFVBQU1FLEdBQU4sR0FBWVQsV0FBV1UsSUFBdkI7O0FBRUEsUUFBTUMsZ0JBQWdCdkIsU0FBU3dCLHFCQUFULENBQStCWixVQUEvQixDQUF0QjtBQUNBLFFBQUlXLGlCQUFpQixPQUFyQixFQUE4QjtBQUMxQjtBQUNBO0FBQ0E7QUFDQSxZQUFNRSxnQkFBbUJGLGFBQW5CLFNBQU47QUFDQUcsZ0NBQXdCUixPQUF4QixFQUFvQ0ssYUFBcEM7QUFDQUcsZ0NBQXdCUixPQUF4QixFQUFpQ08sYUFBakM7O0FBRUFOLGNBQU1RLEdBQU4sR0FBWUYsYUFBWjtBQUNBTixjQUFNQyxTQUFOLElBQW1CLFFBQW5CO0FBQ0E7QUFDQTtBQUNBO0FBQ0gsS0FiRCxNQWFPO0FBQ0g7QUFDQSxZQUFNUSxnQkFBZ0JDLGlCQUFpQk4sYUFBakIsQ0FBdEI7QUFDQTtBQUNBRyxnQ0FBd0JSLE9BQXhCLEVBQWlDVSxjQUFjRSxNQUEvQyxFQUF1RCwwQ0FBdkQ7O0FBRUFYLGNBQU1RLEdBQU4sR0FBWUMsY0FBY0csS0FBMUIsQ0FORyxDQU1nQztBQUN0Qzs7QUFFRGIsWUFBUXRDLE1BQVIsQ0FBZXVDLEtBQWY7QUFDQUYsT0FBR3JDLE1BQUgsQ0FBVXNDLE9BQVY7O0FBRUEsUUFBTUksT0FBT3hELFNBQVNVLGFBQVQsQ0FBdUIsSUFBdkIsQ0FBYjtBQUNBeUMsT0FBR3JDLE1BQUgsQ0FBVTBDLElBQVY7O0FBRUEsUUFBTVUsT0FBT2xFLFNBQVNVLGFBQVQsQ0FBdUIsR0FBdkIsQ0FBYjtBQUNBd0QsU0FBS0MsSUFBTCxHQUFZakMsU0FBU2tDLGdCQUFULENBQTBCdEIsVUFBMUIsQ0FBWjtBQUNBb0IsU0FBS3ZELFNBQUwsR0FBaUJtQyxXQUFXVSxJQUE1QjtBQUNBVSxTQUFLRyxRQUFMLEdBQWdCLENBQWhCO0FBQ0FiLFNBQUsxQyxNQUFMLENBQVlvRCxJQUFaOztBQUVBLFFBQU10RCxlQUFlWixTQUFTVSxhQUFULENBQXVCLEdBQXZCLENBQXJCO0FBQ0FFLGlCQUFhRCxTQUFiLEdBQXlCbUMsV0FBV2xDLFlBQXBDO0FBQ0F1QyxPQUFHckMsTUFBSCxDQUFVRixZQUFWOztBQUVBLFFBQU0wRCxVQUFVdEUsU0FBU1UsYUFBVCxDQUF1QixHQUF2QixDQUFoQjtBQUNBNEQsWUFBUTNELFNBQVIsR0FBb0JtQyxXQUFXd0IsT0FBL0I7QUFDQW5CLE9BQUdyQyxNQUFILENBQVV3RCxPQUFWOztBQUVBLFdBQU9uQixFQUFQO0FBQ0gsQ0FyREQ7O0FBdURBOzs7QUFHQSxJQUFNdkIsa0JBQWtCLFNBQWxCQSxlQUFrQixHQUFvQztBQUFBLFFBQW5DakMsV0FBbUMsdUVBQXJCVSxLQUFLVixXQUFnQjs7QUFDeERBLGdCQUFZYSxPQUFaLENBQW9CLHNCQUFjO0FBQzlCO0FBQ0EsWUFBTStELFNBQVNyQyxTQUFTc0Msc0JBQVQsQ0FBZ0MxQixVQUFoQyxFQUE0Q3pDLEtBQUtQLEdBQWpELENBQWY7QUFDQXdCLGVBQU9DLElBQVAsQ0FBWXJCLEtBQVosQ0FBa0J1RSxXQUFsQixDQUE4QkYsTUFBOUIsRUFBc0MsT0FBdEMsRUFBK0MsWUFBTTtBQUNqRHRELG1CQUFPeUQsUUFBUCxDQUFnQlAsSUFBaEIsR0FBdUJJLE9BQU9JLEdBQTlCO0FBQ0gsU0FGRDtBQUdBdEUsYUFBS04sT0FBTCxDQUFha0QsSUFBYixDQUFrQnNCLE1BQWxCO0FBQ0gsS0FQRDtBQVFILENBVEQiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImxldCByZXN0YXVyYW50cztcclxubGV0IG5laWdoYm9yaG9vZHMgPSBbXTtcclxubGV0IGN1aXNpbmVzID0gW107XHJcbnZhciBtYXBcclxudmFyIG1hcmtlcnMgPSBbXVxyXG5cclxuLyoqXHJcbiAqIEZldGNoIHJlc3RhdXJhbnRzIGFzIHNvb24gYXMgdGhlIHBhZ2UgaXMgbG9hZGVkLlxyXG4gKi9cclxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIChldmVudCkgPT4ge1xyXG4gICAgdXBkYXRlUmVzdGF1cmFudHMoKTtcclxufSk7XHJcblxyXG4vKipcclxuICogU2V0IG5laWdoYm9yaG9vZHMgSFRNTC5cclxuICovXHJcbmNvbnN0IGZpbGxOZWlnaGJvcmhvb2RzSFRNTCA9IChuZWlnaGJvcmhvb2RzID0gc2VsZi5uZWlnaGJvcmhvb2RzKSA9PiB7XHJcbiAgICBjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmVpZ2hib3Job29kcy1zZWxlY3QnKTtcclxuICAgIG5laWdoYm9yaG9vZHMuZm9yRWFjaChuZWlnaGJvcmhvb2QgPT4ge1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xyXG4gICAgICAgIG9wdGlvbi5pbm5lckhUTUwgPSBuZWlnaGJvcmhvb2Q7XHJcbiAgICAgICAgb3B0aW9uLnZhbHVlID0gbmVpZ2hib3Job29kO1xyXG4gICAgICAgIHNlbGVjdC5hcHBlbmQob3B0aW9uKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG4vKipcclxuICogU2V0IGN1aXNpbmVzIEhUTUwuXHJcbiAqL1xyXG5jb25zdCBmaWxsQ3Vpc2luZXNIVE1MID0gKGN1aXNpbmVzID0gc2VsZi5jdWlzaW5lcykgPT4ge1xyXG4gICAgY29uc3Qgc2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1aXNpbmVzLXNlbGVjdCcpO1xyXG5cclxuICAgIGN1aXNpbmVzLmZvckVhY2goY3Vpc2luZSA9PiB7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7XHJcbiAgICAgICAgb3B0aW9uLmlubmVySFRNTCA9IGN1aXNpbmU7XHJcbiAgICAgICAgb3B0aW9uLnZhbHVlID0gY3Vpc2luZTtcclxuICAgICAgICBzZWxlY3QuYXBwZW5kKG9wdGlvbik7XHJcbiAgICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEluaXRpYWxpemUgR29vZ2xlIG1hcCwgY2FsbGVkIGZyb20gSFRNTC5cclxuICovXHJcbndpbmRvdy5pbml0TWFwID0gKCkgPT4ge1xyXG4gICAgbGV0IGxvYyA9IHtcclxuICAgICAgICBsYXQ6IDQwLjcyMjIxNixcclxuICAgICAgICBsbmc6IC03My45ODc1MDFcclxuICAgIH07XHJcbiAgICBzZWxmLm1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLCB7XHJcbiAgICAgICAgem9vbTogMTIsXHJcbiAgICAgICAgY2VudGVyOiBsb2MsXHJcbiAgICAgICAgc2Nyb2xsd2hlZWw6IGZhbHNlXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBBZGQgbWFya2VycyB0byB0aGUgbWFwIGFmdGVyIGJlaW5nIGluaXRpYWxpemVkXHJcbiAgICBhZGRNYXJrZXJzVG9NYXAoKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFVwZGF0ZSBwYWdlIGFuZCBtYXAgZm9yIGN1cnJlbnQgcmVzdGF1cmFudHMuXHJcbiAqL1xyXG5jb25zdCB1cGRhdGVSZXN0YXVyYW50cyA9ICgpID0+IHtcclxuICAgIGNvbnN0IGNTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY3Vpc2luZXMtc2VsZWN0Jyk7XHJcbiAgICBjb25zdCBuU2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25laWdoYm9yaG9vZHMtc2VsZWN0Jyk7XHJcblxyXG4gICAgY29uc3QgY0luZGV4ID0gY1NlbGVjdC5zZWxlY3RlZEluZGV4O1xyXG4gICAgY29uc3QgbkluZGV4ID0gblNlbGVjdC5zZWxlY3RlZEluZGV4O1xyXG5cclxuICAgIGNvbnN0IGN1aXNpbmUgPSBjU2VsZWN0W2NJbmRleF0udmFsdWU7XHJcbiAgICBjb25zdCBuZWlnaGJvcmhvb2QgPSBuU2VsZWN0W25JbmRleF0udmFsdWU7XHJcblxyXG4gICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lQW5kTmVpZ2hib3Job29kKGN1aXNpbmUsIG5laWdoYm9yaG9vZCwgKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICAgIGlmIChlcnJvcikgeyAvLyBHb3QgYW4gZXJyb3IhXHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJlc2V0UmVzdGF1cmFudHMocmVzdGF1cmFudHMpO1xyXG4gICAgICAgICAgICBmaWxsUmVzdGF1cmFudHNIVE1MKCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBJbmNsdWRlIG1hcHMgYXBpIGR5bmFtaWNhbGx5IG9ubHkgYWZ0ZXIgZXZlcnl0aGluZyBlbHNlIGhhcyBiZWVuIGRvbmVcclxuICAgICAgICAgICAgZ2V0R29vZ2xlTWFwc0FwaSgpO1xyXG4gICAgICAgIH1cclxuICAgIH0pXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDbGVhciBjdXJyZW50IHJlc3RhdXJhbnRzLCB0aGVpciBIVE1MIGFuZCByZW1vdmUgdGhlaXIgbWFwIG1hcmtlcnMuXHJcbiAqL1xyXG5jb25zdCByZXNldFJlc3RhdXJhbnRzID0gKHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAvLyBSZW1vdmUgYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBzZWxmLnJlc3RhdXJhbnRzID0gW107XHJcbiAgICBjb25zdCB1bCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50cy1saXN0Jyk7XHJcbiAgICB1bC5pbm5lckhUTUwgPSAnJztcclxuXHJcbiAgICAvLyBSZW1vdmUgYWxsIG1hcCBtYXJrZXJzXHJcbiAgICBzZWxmLm1hcmtlcnMuZm9yRWFjaChtID0+IG0uc2V0TWFwKG51bGwpKTtcclxuICAgIHNlbGYubWFya2VycyA9IFtdO1xyXG4gICAgc2VsZi5yZXN0YXVyYW50cyA9IHJlc3RhdXJhbnRzO1xyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlIGFsbCByZXN0YXVyYW50cyBIVE1MIGFuZCBhZGQgdGhlbSB0byB0aGUgd2VicGFnZS5cclxuICovXHJcbmNvbnN0IGZpbGxSZXN0YXVyYW50c0hUTUwgPSAocmVzdGF1cmFudHMgPSBzZWxmLnJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICBjb25zdCB1bCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50cy1saXN0Jyk7XHJcbiAgICByZXN0YXVyYW50cy5mb3JFYWNoKHJlc3RhdXJhbnQgPT4ge1xyXG4gICAgICAgIGlmIChEQkhlbHBlci5hZGRSZXN0YXVyYW50cygpKSB7XHJcbiAgICAgICAgICAgIERCSGVscGVyLmFkZFJlc3RhdXJhbnRUb0RhdGFiYXNlKHJlc3RhdXJhbnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB1bC5hcHBlbmQoY3JlYXRlUmVzdGF1cmFudEhUTUwocmVzdGF1cmFudCkpO1xyXG5cclxuICAgICAgICBpZiAoIXNlbGYubmVpZ2hib3Job29kcy5pbmNsdWRlcyhyZXN0YXVyYW50Lm5laWdoYm9yaG9vZCkpIHtcclxuICAgICAgICAgICAgc2VsZi5uZWlnaGJvcmhvb2RzLnB1c2gocmVzdGF1cmFudC5uZWlnaGJvcmhvb2QpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCFzZWxmLmN1aXNpbmVzLmluY2x1ZGVzKHJlc3RhdXJhbnQuY3Vpc2luZV90eXBlKSkge1xyXG4gICAgICAgICAgICBzZWxmLmN1aXNpbmVzLnB1c2gocmVzdGF1cmFudC5jdWlzaW5lX3R5cGUpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGZpbGxOZWlnaGJvcmhvb2RzSFRNTCgpO1xyXG4gICAgZmlsbEN1aXNpbmVzSFRNTCgpO1xyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlIHJlc3RhdXJhbnQgSFRNTC5cclxuICovXHJcbmNvbnN0IGNyZWF0ZVJlc3RhdXJhbnRIVE1MID0gKHJlc3RhdXJhbnQpID0+IHtcclxuICAgIGNvbnN0IGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcclxuXHJcbiAgICAvLyBjcmVhdGUgcGljdHVyZSBlbGVtZW50IGZvciByZXN0YXVyYW50IGltYWdlIGluIHJlc3RhdXJhbnQgbGlzdFxyXG4gICAgY29uc3QgcGljdHVyZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3BpY3R1cmUnKTtcclxuICAgIGNvbnN0IGltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7XHJcbiAgICBpbWFnZS5jbGFzc05hbWUgPSAncmVzdGF1cmFudC1pbWcnO1xyXG4gICAgaW1hZ2UuYWx0ID0gcmVzdGF1cmFudC5uYW1lO1xyXG5cclxuICAgIGNvbnN0IGltYWdlRmlsZW5hbWUgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XHJcbiAgICBpZiAoaW1hZ2VGaWxlbmFtZSA9PSAnbm9pbWcnKSB7XHJcbiAgICAgICAgLy8gSWYgcmVzdGF1cmFudCBoYXMgbm90IGFuIGltYWdlLCBkaXNwbGF5IGEgbm8gaW1hZ2Ugc3ZnXHJcbiAgICAgICAgLy8gYW5kIHVzZSBpdHMgY29ycmVzcG9uZGluZyBwbmcgYXMgYSBmYWxsYmFjay5cclxuICAgICAgICAvLyBBdXRob3Igb2YgdGhlIG5vaW1nLnN2ZyBhbmQgbm9pbWcucG5nIGlzIGNyZWRpdGVkIGF0IHBhZ2UncyBmb290ZXIuXHJcbiAgICAgICAgY29uc3Qgbm9JbWdGYWxsYmFjayA9IGAke2ltYWdlRmlsZW5hbWV9LnBuZ2A7XHJcbiAgICAgICAgYWRkSW1hZ2VTb3VyY2VUb1BpY3R1cmUocGljdHVyZSwgYCR7aW1hZ2VGaWxlbmFtZX0uc3ZnYCk7XHJcbiAgICAgICAgYWRkSW1hZ2VTb3VyY2VUb1BpY3R1cmUocGljdHVyZSwgbm9JbWdGYWxsYmFjayk7XHJcblxyXG4gICAgICAgIGltYWdlLnNyYyA9IG5vSW1nRmFsbGJhY2s7XHJcbiAgICAgICAgaW1hZ2UuY2xhc3NOYW1lICs9ICcgbm9pbWcnO1xyXG4gICAgICAgIC8vIFRPRE86IEZpeCBub2ltZyBzdmcgcmVzcG9uc2l2ZSBoZWlnaHRcclxuICAgICAgICAvLyBUT0RPOiBGaXggbm9pbWcgcG5nIGZhbGxiYWNrIGluIElFXHJcbiAgICAgICAgLy8gVE9ETzogQ2FjaGUgbm9pbWcgc3ZnIGFuZCBwbmdcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gZ2V0IGFsbCBwb3NzaWJsZSBuYW1lcyBvZiBhbiBpbWFnZSBkZXBlbmRpbmcgb24gaXRzIHNpemUgKHNtYWxsLCBtZWRpdW0sIGxhcmdlKVxyXG4gICAgICAgIGNvbnN0IGltYWdlc1Jlc2l6ZWQgPSBpbWFnZU5hbWVzQnlTaXplKGltYWdlRmlsZW5hbWUpO1xyXG4gICAgICAgIC8vIGFkZCBzb3VyY2UgdG8gcGljdHVyZSBlbGVtZW50IGZvciBtZWRpdW0gc2NyZWVuc1xyXG4gICAgICAgIGFkZEltYWdlU291cmNlVG9QaWN0dXJlKHBpY3R1cmUsIGltYWdlc1Jlc2l6ZWQubWVkaXVtLCAnKG1pbi13aWR0aDogMzYzcHgpIGFuZCAobWF4LXdpZHRoOjQ3OXB4KScpO1xyXG5cclxuICAgICAgICBpbWFnZS5zcmMgPSBpbWFnZXNSZXNpemVkLnNtYWxsOyAgIC8vIHNtYWxsIGltYWdlIGJ5IGRlZmF1bHRcclxuICAgIH1cclxuXHJcbiAgICBwaWN0dXJlLmFwcGVuZChpbWFnZSk7XHJcbiAgICBsaS5hcHBlbmQocGljdHVyZSk7XHJcblxyXG4gICAgY29uc3QgbmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gzJyk7XHJcbiAgICBsaS5hcHBlbmQobmFtZSk7XHJcblxyXG4gICAgY29uc3QgbW9yZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcclxuICAgIG1vcmUuaHJlZiA9IERCSGVscGVyLnVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XHJcbiAgICBtb3JlLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmFtZTtcclxuICAgIG1vcmUudGFiSW5kZXggPSAwO1xyXG4gICAgbmFtZS5hcHBlbmQobW9yZSk7XHJcblxyXG4gICAgY29uc3QgbmVpZ2hib3Job29kID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgbmVpZ2hib3Job29kLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmVpZ2hib3Job29kO1xyXG4gICAgbGkuYXBwZW5kKG5laWdoYm9yaG9vZCk7XHJcblxyXG4gICAgY29uc3QgYWRkcmVzcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICAgIGFkZHJlc3MuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5hZGRyZXNzO1xyXG4gICAgbGkuYXBwZW5kKGFkZHJlc3MpO1xyXG5cclxuICAgIHJldHVybiBsaVxyXG59XHJcblxyXG4vKipcclxuICogQWRkIG1hcmtlcnMgZm9yIGN1cnJlbnQgcmVzdGF1cmFudHMgdG8gdGhlIG1hcC5cclxuICovXHJcbmNvbnN0IGFkZE1hcmtlcnNUb01hcCA9IChyZXN0YXVyYW50cyA9IHNlbGYucmVzdGF1cmFudHMpID0+IHtcclxuICAgIHJlc3RhdXJhbnRzLmZvckVhY2gocmVzdGF1cmFudCA9PiB7XHJcbiAgICAgICAgLy8gQWRkIG1hcmtlciB0byB0aGUgbWFwXHJcbiAgICAgICAgY29uc3QgbWFya2VyID0gREJIZWxwZXIubWFwTWFya2VyRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBzZWxmLm1hcCk7XHJcbiAgICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIobWFya2VyLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gbWFya2VyLnVybFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNlbGYubWFya2Vycy5wdXNoKG1hcmtlcik7XHJcbiAgICB9KTtcclxufVxyXG4iXX0=

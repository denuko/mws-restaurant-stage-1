'use strict';

var restaurants = void 0;
var neighborhoods = [];
var cuisines = [];
var map;
var markers = [];

/**
 * Fetch restaurants as soon as the page is loaded.
 */
document.addEventListener('DOMContentLoaded', function (event) {
    updateRestaurants();
});

/**
 * Set neighborhoods HTML.
 */
var fillNeighborhoodsHTML = function fillNeighborhoodsHTML() {
    var neighborhoods = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.neighborhoods;

    var select = document.getElementById('neighborhoods-select');
    neighborhoods.forEach(function (neighborhood) {
        var option = document.createElement('option');
        option.innerHTML = neighborhood;
        option.value = neighborhood;
        select.append(option);
    });
};

/**
 * Set cuisines HTML.
 */
var fillCuisinesHTML = function fillCuisinesHTML() {
    var cuisines = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.cuisines;

    var select = document.getElementById('cuisines-select');

    cuisines.forEach(function (cuisine) {
        var option = document.createElement('option');
        option.innerHTML = cuisine;
        option.value = cuisine;
        select.append(option);
    });
};

/**
 * Initialize Google map, called from HTML.
 */
window.initMap = function () {
    var loc = {
        lat: 40.722216,
        lng: -73.987501
    };
    self.map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: loc,
        scrollwheel: false
    });

    // Add markers to the map after being initialized
    addMarkersToMap();
};

/**
 * Update page and map for current restaurants.
 */
var updateRestaurants = function updateRestaurants() {
    var cSelect = document.getElementById('cuisines-select');
    var nSelect = document.getElementById('neighborhoods-select');

    var cIndex = cSelect.selectedIndex;
    var nIndex = nSelect.selectedIndex;

    var cuisine = cSelect[cIndex].value;
    var neighborhood = nSelect[nIndex].value;

    DBHelper.fetchRestaurantByCuisineAndNeighborhood(cuisine, neighborhood, function (error, restaurants) {
        if (error) {
            // Got an error!
            console.error(error);
        } else {
            resetRestaurants(restaurants);
            fillRestaurantsHTML();
            // Include LazyLoad plugin
            getLazyLoadPlugin();
            // Include maps api dynamically only after everything else has been done
            getGoogleMapsApi();
        }
    });
};

/**
 * Clear current restaurants, their HTML and remove their map markers.
 */
var resetRestaurants = function resetRestaurants(restaurants) {
    // Remove all restaurants
    self.restaurants = [];
    var ul = document.getElementById('restaurants-list');
    ul.innerHTML = '';

    // Remove all map markers
    self.markers.forEach(function (m) {
        return m.setMap(null);
    });
    self.markers = [];
    self.restaurants = restaurants;
};

/**
 * Create all restaurants HTML and add them to the webpage.
 */
var fillRestaurantsHTML = function fillRestaurantsHTML() {
    var restaurants = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurants;

    var ul = document.getElementById('restaurants-list');
    restaurants.forEach(function (restaurant) {
        if (DBHelper.addRestaurants()) {
            DBHelper.addRestaurantToDatabase(restaurant);
        }
        ul.append(createRestaurantHTML(restaurant));

        if (!self.neighborhoods.includes(restaurant.neighborhood)) {
            self.neighborhoods.push(restaurant.neighborhood);
        }

        if (!self.cuisines.includes(restaurant.cuisine_type)) {
            self.cuisines.push(restaurant.cuisine_type);
        }
    });

    fillNeighborhoodsHTML();
    fillCuisinesHTML();
};

/**
 * Create restaurant HTML.
 */
var createRestaurantHTML = function createRestaurantHTML(restaurant) {
    var li = document.createElement('li');

    // create picture element for restaurant image in restaurant list
    var picture = document.createElement('picture');
    var image = document.createElement('img');
    image.className = 'restaurant-img lazy';
    image.alt = restaurant.name;

    var imageFilename = DBHelper.imageUrlForRestaurant(restaurant);
    if (imageFilename == 'noimg') {
        // If restaurant has not an image, display a no image svg
        // and use its corresponding png as a fallback.
        // Author of the noimg.svg and noimg.png is credited at page's footer.
        var noImgFallback = imageFilename + '.png';
        addImageSourceToPicture(picture, imageFilename + '.svg');
        addImageSourceToPicture(picture, noImgFallback);

        image.setAttribute('data-src', noImgFallback);
        image.className += ' noimg';
        // TODO: Fix noimg png fallback in IE
    } else {
        // get all possible names of an image depending on its size (small, medium, large)
        var imagesResized = imageNamesBySize(imageFilename);
        // add source to picture element for medium screens
        addImageSourceToPicture(picture, imagesResized.medium, '(min-width: 363px) and (max-width:479px)');

        image.setAttribute('data-src', imagesResized.small);
    }

    picture.append(image);
    li.append(picture);

    var name = document.createElement('h3');
    li.append(name);

    var more = document.createElement('a');
    more.href = DBHelper.urlForRestaurant(restaurant);
    more.innerHTML = restaurant.name;
    more.tabIndex = 0;
    name.append(more);

    var neighborhood = document.createElement('p');
    neighborhood.innerHTML = restaurant.neighborhood;
    li.append(neighborhood);

    var address = document.createElement('p');
    address.innerHTML = restaurant.address;
    li.append(address);

    return li;
};

/**
 * Add markers for current restaurants to the map.
 */
var addMarkersToMap = function addMarkersToMap() {
    var restaurants = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurants;

    restaurants.forEach(function (restaurant) {
        // Add marker to the map
        var marker = DBHelper.mapMarkerForRestaurant(restaurant, self.map);
        google.maps.event.addListener(marker, 'click', function () {
            window.location.href = marker.url;
        });
        self.markers.push(marker);
    });
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsicmVzdGF1cmFudHMiLCJuZWlnaGJvcmhvb2RzIiwiY3Vpc2luZXMiLCJtYXAiLCJtYXJrZXJzIiwiZG9jdW1lbnQiLCJhZGRFdmVudExpc3RlbmVyIiwiZXZlbnQiLCJ1cGRhdGVSZXN0YXVyYW50cyIsImZpbGxOZWlnaGJvcmhvb2RzSFRNTCIsInNlbGYiLCJzZWxlY3QiLCJnZXRFbGVtZW50QnlJZCIsImZvckVhY2giLCJvcHRpb24iLCJjcmVhdGVFbGVtZW50IiwiaW5uZXJIVE1MIiwibmVpZ2hib3Job29kIiwidmFsdWUiLCJhcHBlbmQiLCJmaWxsQ3Vpc2luZXNIVE1MIiwiY3Vpc2luZSIsIndpbmRvdyIsImluaXRNYXAiLCJsb2MiLCJsYXQiLCJsbmciLCJnb29nbGUiLCJtYXBzIiwiTWFwIiwiem9vbSIsImNlbnRlciIsInNjcm9sbHdoZWVsIiwiYWRkTWFya2Vyc1RvTWFwIiwiY1NlbGVjdCIsIm5TZWxlY3QiLCJjSW5kZXgiLCJzZWxlY3RlZEluZGV4IiwibkluZGV4IiwiREJIZWxwZXIiLCJmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QiLCJlcnJvciIsImNvbnNvbGUiLCJyZXNldFJlc3RhdXJhbnRzIiwiZmlsbFJlc3RhdXJhbnRzSFRNTCIsImdldExhenlMb2FkUGx1Z2luIiwiZ2V0R29vZ2xlTWFwc0FwaSIsInVsIiwibSIsInNldE1hcCIsImFkZFJlc3RhdXJhbnRzIiwiYWRkUmVzdGF1cmFudFRvRGF0YWJhc2UiLCJyZXN0YXVyYW50IiwiY3JlYXRlUmVzdGF1cmFudEhUTUwiLCJpbmNsdWRlcyIsInB1c2giLCJjdWlzaW5lX3R5cGUiLCJsaSIsInBpY3R1cmUiLCJpbWFnZSIsImNsYXNzTmFtZSIsImFsdCIsIm5hbWUiLCJpbWFnZUZpbGVuYW1lIiwiaW1hZ2VVcmxGb3JSZXN0YXVyYW50Iiwibm9JbWdGYWxsYmFjayIsImFkZEltYWdlU291cmNlVG9QaWN0dXJlIiwic2V0QXR0cmlidXRlIiwiaW1hZ2VzUmVzaXplZCIsImltYWdlTmFtZXNCeVNpemUiLCJtZWRpdW0iLCJzbWFsbCIsIm1vcmUiLCJocmVmIiwidXJsRm9yUmVzdGF1cmFudCIsInRhYkluZGV4IiwiYWRkcmVzcyIsIm1hcmtlciIsIm1hcE1hcmtlckZvclJlc3RhdXJhbnQiLCJhZGRMaXN0ZW5lciIsImxvY2F0aW9uIiwidXJsIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUlBLG9CQUFKO0FBQ0EsSUFBSUMsZ0JBQWdCLEVBQXBCO0FBQ0EsSUFBSUMsV0FBVyxFQUFmO0FBQ0EsSUFBSUMsR0FBSjtBQUNBLElBQUlDLFVBQVUsRUFBZDs7QUFFQTs7O0FBR0FDLFNBQVNDLGdCQUFULENBQTBCLGtCQUExQixFQUE4QyxVQUFDQyxLQUFELEVBQVc7QUFDckRDO0FBQ0gsQ0FGRDs7QUFJQTs7O0FBR0EsSUFBTUMsd0JBQXdCLFNBQXhCQSxxQkFBd0IsR0FBd0M7QUFBQSxRQUF2Q1IsYUFBdUMsdUVBQXZCUyxLQUFLVCxhQUFrQjs7QUFDbEUsUUFBTVUsU0FBU04sU0FBU08sY0FBVCxDQUF3QixzQkFBeEIsQ0FBZjtBQUNBWCxrQkFBY1ksT0FBZCxDQUFzQix3QkFBZ0I7QUFDbEMsWUFBTUMsU0FBU1QsU0FBU1UsYUFBVCxDQUF1QixRQUF2QixDQUFmO0FBQ0FELGVBQU9FLFNBQVAsR0FBbUJDLFlBQW5CO0FBQ0FILGVBQU9JLEtBQVAsR0FBZUQsWUFBZjtBQUNBTixlQUFPUSxNQUFQLENBQWNMLE1BQWQ7QUFDSCxLQUxEO0FBTUgsQ0FSRDs7QUFVQTs7O0FBR0EsSUFBTU0sbUJBQW1CLFNBQW5CQSxnQkFBbUIsR0FBOEI7QUFBQSxRQUE3QmxCLFFBQTZCLHVFQUFsQlEsS0FBS1IsUUFBYTs7QUFDbkQsUUFBTVMsU0FBU04sU0FBU08sY0FBVCxDQUF3QixpQkFBeEIsQ0FBZjs7QUFFQVYsYUFBU1csT0FBVCxDQUFpQixtQkFBVztBQUN4QixZQUFNQyxTQUFTVCxTQUFTVSxhQUFULENBQXVCLFFBQXZCLENBQWY7QUFD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Z2hib3Job29kcyA9IFtdO1xyXG5sZXQgY3Vpc2luZXMgPSBbXTtcclxudmFyIG1hcFxyXG52YXIgbWFya2VycyA9IFtdXHJcblxyXG4vKipcclxuICogRmV0Y2ggcmVzdGF1cmFudHMgYXMgc29vbiBhcyB0aGUgcGFnZSBpcyBsb2FkZWQuXHJcbiAqL1xyXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgKGV2ZW50KSA9PiB7XHJcbiAgICB1cGRhdGVSZXN0YXVyYW50cygpO1xyXG59KTtcclxuXHJcbi8qKlxyXG4gKiBTZXQgbmVpZ2hib3Job29kcyBIVE1MLlxyXG4gKi9cclxuY29uc3QgZmlsbE5laWdoYm9yaG9vZHNIVE1MID0gKG5laWdoYm9yaG9vZHMgPSBzZWxmLm5laWdoYm9yaG9vZHMpID0+IHtcclxuICAgIGNvbnN0IHNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduZWlnaGJvcmhvb2RzLXNlbGVjdCcpO1xyXG4gICAgbmVpZ2hib3Job29kcy5mb3JFYWNoKG5laWdoYm9yaG9vZCA9PiB7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7XHJcbiAgICAgICAgb3B0aW9uLmlubmVySFRNTCA9IG5laWdoYm9yaG9vZDtcclxuICAgICAgICBvcHRpb24udmFsdWUgPSBuZWlnaGJvcmhvb2Q7XHJcbiAgICAgICAgc2VsZWN0LmFwcGVuZChvcHRpb24pO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBTZXQgY3Vpc2luZXMgSFRNTC5cclxuICovXHJcbmNvbnN0IGZpbGxDdWlzaW5lc0hUTUwgPSAoY3Vpc2luZXMgPSBzZWxmLmN1aXNpbmVzKSA9PiB7XHJcbiAgICBjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY3Vpc2luZXMtc2VsZWN0Jyk7XHJcblxyXG4gICAgY3Vpc2luZXMuZm9yRWFjaChjdWlzaW5lID0+IHtcclxuICAgICAgICBjb25zdCBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKTtcclxuICAgICAgICBvcHRpb24uaW5uZXJIVE1MID0gY3Vpc2luZTtcclxuICAgICAgICBvcHRpb24udmFsdWUgPSBjdWlzaW5lO1xyXG4gICAgICAgIHNlbGVjdC5hcHBlbmQob3B0aW9uKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG4vKipcclxuICogSW5pdGlhbGl6ZSBHb29nbGUgbWFwLCBjYWxsZWQgZnJvbSBIVE1MLlxyXG4gKi9cclxud2luZG93LmluaXRNYXAgPSAoKSA9PiB7XHJcbiAgICBsZXQgbG9jID0ge1xyXG4gICAgICAgIGxhdDogNDAuNzIyMjE2LFxyXG4gICAgICAgIGxuZzogLTczLjk4NzUwMVxyXG4gICAgfTtcclxuICAgIHNlbGYubWFwID0gbmV3IGdvb2dsZS5tYXBzLk1hcChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFwJyksIHtcclxuICAgICAgICB6b29tOiAxMixcclxuICAgICAgICBjZW50ZXI6IGxvYyxcclxuICAgICAgICBzY3JvbGx3aGVlbDogZmFsc2VcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIEFkZCBtYXJrZXJzIHRvIHRoZSBtYXAgYWZ0ZXIgYmVpbmcgaW5pdGlhbGl6ZWRcclxuICAgIGFkZE1hcmtlcnNUb01hcCgpO1xyXG59XHJcblxyXG4vKipcclxuICogVXBkYXRlIHBhZ2UgYW5kIG1hcCBmb3IgY3VycmVudCByZXN0YXVyYW50cy5cclxuICovXHJcbmNvbnN0IHVwZGF0ZVJlc3RhdXJhbnRzID0gKCkgPT4ge1xyXG4gICAgY29uc3QgY1NlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdWlzaW5lcy1zZWxlY3QnKTtcclxuICAgIGNvbnN0IG5TZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmVpZ2hib3Job29kcy1zZWxlY3QnKTtcclxuXHJcbiAgICBjb25zdCBjSW5kZXggPSBjU2VsZWN0LnNlbGVjdGVkSW5kZXg7XHJcbiAgICBjb25zdCBuSW5kZXggPSBuU2VsZWN0LnNlbGVjdGVkSW5kZXg7XHJcblxyXG4gICAgY29uc3QgY3Vpc2luZSA9IGNTZWxlY3RbY0luZGV4XS52YWx1ZTtcclxuICAgIGNvbnN0IG5laWdoYm9yaG9vZCA9IG5TZWxlY3RbbkluZGV4XS52YWx1ZTtcclxuXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kLCAoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgICAgaWYgKGVycm9yKSB7IC8vIEdvdCBhbiBlcnJvciFcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVzZXRSZXN0YXVyYW50cyhyZXN0YXVyYW50cyk7XHJcbiAgICAgICAgICAgIGZpbGxSZXN0YXVyYW50c0hUTUwoKTtcclxuICAgICAgICAgICAgLy8gSW5jbHVkZSBMYXp5TG9hZCBwbHVnaW5cclxuICAgICAgICAgICAgZ2V0TGF6eUxvYWRQbHVnaW4oKTtcclxuICAgICAgICAgICAgLy8gSW5jbHVkZSBtYXBzIGFwaSBkeW5hbWljYWxseSBvbmx5IGFmdGVyIGV2ZXJ5dGhpbmcgZWxzZSBoYXMgYmVlbiBkb25lXHJcbiAgICAgICAgICAgIGdldEdvb2dsZU1hcHNBcGkoKTtcclxuICAgICAgICB9XHJcbiAgICB9KVxyXG59XHJcblxyXG4vKipcclxuICogQ2xlYXIgY3VycmVudCByZXN0YXVyYW50cywgdGhlaXIgSFRNTCBhbmQgcmVtb3ZlIHRoZWlyIG1hcCBtYXJrZXJzLlxyXG4gKi9cclxuY29uc3QgcmVzZXRSZXN0YXVyYW50cyA9IChyZXN0YXVyYW50cykgPT4ge1xyXG4gICAgLy8gUmVtb3ZlIGFsbCByZXN0YXVyYW50c1xyXG4gICAgc2VsZi5yZXN0YXVyYW50cyA9IFtdO1xyXG4gICAgY29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudHMtbGlzdCcpO1xyXG4gICAgdWwuaW5uZXJIVE1MID0gJyc7XHJcblxyXG4gICAgLy8gUmVtb3ZlIGFsbCBtYXAgbWFya2Vyc1xyXG4gICAgc2VsZi5tYXJrZXJzLmZvckVhY2gobSA9PiBtLnNldE1hcChudWxsKSk7XHJcbiAgICBzZWxmLm1hcmtlcnMgPSBbXTtcclxuICAgIHNlbGYucmVzdGF1cmFudHMgPSByZXN0YXVyYW50cztcclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSBhbGwgcmVzdGF1cmFudHMgSFRNTCBhbmQgYWRkIHRoZW0gdG8gdGhlIHdlYnBhZ2UuXHJcbiAqL1xyXG5jb25zdCBmaWxsUmVzdGF1cmFudHNIVE1MID0gKHJlc3RhdXJhbnRzID0gc2VsZi5yZXN0YXVyYW50cykgPT4ge1xyXG4gICAgY29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudHMtbGlzdCcpO1xyXG4gICAgcmVzdGF1cmFudHMuZm9yRWFjaChyZXN0YXVyYW50ID0+IHtcclxuICAgICAgICBpZiAoREJIZWxwZXIuYWRkUmVzdGF1cmFudHMoKSkge1xyXG4gICAgICAgICAgICBEQkhlbHBlci5hZGRSZXN0YXVyYW50VG9EYXRhYmFzZShyZXN0YXVyYW50KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdWwuYXBwZW5kKGNyZWF0ZVJlc3RhdXJhbnRIVE1MKHJlc3RhdXJhbnQpKTtcclxuXHJcbiAgICAgICAgaWYgKCFzZWxmLm5laWdoYm9yaG9vZHMuaW5jbHVkZXMocmVzdGF1cmFudC5uZWlnaGJvcmhvb2QpKSB7XHJcbiAgICAgICAgICAgIHNlbGYubmVpZ2hib3Job29kcy5wdXNoKHJlc3RhdXJhbnQubmVpZ2hib3Job29kKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghc2VsZi5jdWlzaW5lcy5pbmNsdWRlcyhyZXN0YXVyYW50LmN1aXNpbmVfdHlwZSkpIHtcclxuICAgICAgICAgICAgc2VsZi5jdWlzaW5lcy5wdXNoKHJlc3RhdXJhbnQuY3Vpc2luZV90eXBlKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBmaWxsTmVpZ2hib3Job29kc0hUTUwoKTtcclxuICAgIGZpbGxDdWlzaW5lc0hUTUwoKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSByZXN0YXVyYW50IEhUTUwuXHJcbiAqL1xyXG5jb25zdCBjcmVhdGVSZXN0YXVyYW50SFRNTCA9IChyZXN0YXVyYW50KSA9PiB7XHJcbiAgICBjb25zdCBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XHJcblxyXG4gICAgLy8gY3JlYXRlIHBpY3R1cmUgZWxlbWVudCBmb3IgcmVzdGF1cmFudCBpbWFnZSBpbiByZXN0YXVyYW50IGxpc3RcclxuICAgIGNvbnN0IHBpY3R1cmUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwaWN0dXJlJyk7XHJcbiAgICBjb25zdCBpbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xyXG4gICAgaW1hZ2UuY2xhc3NOYW1lID0gJ3Jlc3RhdXJhbnQtaW1nIGxhenknO1xyXG4gICAgaW1hZ2UuYWx0ID0gcmVzdGF1cmFudC5uYW1lO1xyXG5cclxuICAgIGNvbnN0IGltYWdlRmlsZW5hbWUgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XHJcbiAgICBpZiAoaW1hZ2VGaWxlbmFtZSA9PSAnbm9pbWcnKSB7XHJcbiAgICAgICAgLy8gSWYgcmVzdGF1cmFudCBoYXMgbm90IGFuIGltYWdlLCBkaXNwbGF5IGEgbm8gaW1hZ2Ugc3ZnXHJcbiAgICAgICAgLy8gYW5kIHVzZSBpdHMgY29ycmVzcG9uZGluZyBwbmcgYXMgYSBmYWxsYmFjay5cclxuICAgICAgICAvLyBBdXRob3Igb2YgdGhlIG5vaW1nLnN2ZyBhbmQgbm9pbWcucG5nIGlzIGNyZWRpdGVkIGF0IHBhZ2UncyBmb290ZXIuXHJcbiAgICAgICAgY29uc3Qgbm9JbWdGYWxsYmFjayA9IGAke2ltYWdlRmlsZW5hbWV9LnBuZ2A7XHJcbiAgICAgICAgYWRkSW1hZ2VTb3VyY2VUb1BpY3R1cmUocGljdHVyZSwgYCR7aW1hZ2VGaWxlbmFtZX0uc3ZnYCk7XHJcbiAgICAgICAgYWRkSW1hZ2VTb3VyY2VUb1BpY3R1cmUocGljdHVyZSwgbm9JbWdGYWxsYmFjayk7XHJcblxyXG4gICAgICAgIGltYWdlLnNldEF0dHJpYnV0ZSgnZGF0YS1zcmMnLCBub0ltZ0ZhbGxiYWNrKTtcclxuICAgICAgICBpbWFnZS5jbGFzc05hbWUgKz0gJyBub2ltZyc7XHJcbiAgICAgICAgLy8gVE9ETzogRml4IG5vaW1nIHBuZyBmYWxsYmFjayBpbiBJRVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBnZXQgYWxsIHBvc3NpYmxlIG5hbWVzIG9mIGFuIGltYWdlIGRlcGVuZGluZyBvbiBpdHMgc2l6ZSAoc21hbGwsIG1lZGl1bSwgbGFyZ2UpXHJcbiAgICAgICAgY29uc3QgaW1hZ2VzUmVzaXplZCA9IGltYWdlTmFtZXNCeVNpemUoaW1hZ2VGaWxlbmFtZSk7XHJcbiAgICAgICAgLy8gYWRkIHNvdXJjZSB0byBwaWN0dXJlIGVsZW1lbnQgZm9yIG1lZGl1bSBzY3JlZW5zXHJcbiAgICAgICAgYWRkSW1hZ2VTb3VyY2VUb1BpY3R1cmUocGljdHVyZSwgaW1hZ2VzUmVzaXplZC5tZWRpdW0sICcobWluLXdpZHRoOiAzNjNweCkgYW5kIChtYXgtd2lkdGg6NDc5cHgpJyk7XHJcblxyXG4gICAgICAgIGltYWdlLnNldEF0dHJpYnV0ZSgnZGF0YS1zcmMnLCBpbWFnZXNSZXNpemVkLnNtYWxsKTtcclxuICAgIH1cclxuXHJcbiAgICBwaWN0dXJlLmFwcGVuZChpbWFnZSk7XHJcbiAgICBsaS5hcHBlbmQocGljdHVyZSk7XHJcblxyXG4gICAgY29uc3QgbmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gzJyk7XHJcbiAgICBsaS5hcHBlbmQobmFtZSk7XHJcblxyXG4gICAgY29uc3QgbW9yZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcclxuICAgIG1vcmUuaHJlZiA9IERCSGVscGVyLnVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XHJcbiAgICBtb3JlLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmFtZTtcclxuICAgIG1vcmUudGFiSW5kZXggPSAwO1xyXG4gICAgbmFtZS5hcHBlbmQobW9yZSk7XHJcblxyXG4gICAgY29uc3QgbmVpZ2hib3Job29kID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgbmVpZ2hib3Job29kLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmVpZ2hib3Job29kO1xyXG4gICAgbGkuYXBwZW5kKG5laWdoYm9yaG9vZCk7XHJcblxyXG4gICAgY29uc3QgYWRkcmVzcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICAgIGFkZHJlc3MuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5hZGRyZXNzO1xyXG4gICAgbGkuYXBwZW5kKGFkZHJlc3MpO1xyXG5cclxuICAgIHJldHVybiBsaVxyXG59XHJcblxyXG4vKipcclxuICogQWRkIG1hcmtlcnMgZm9yIGN1cnJlbnQgcmVzdGF1cmFudHMgdG8gdGhlIG1hcC5cclxuICovXHJcbmNvbnN0IGFkZE1hcmtlcnNUb01hcCA9IChyZXN0YXVyYW50cyA9IHNlbGYucmVzdGF1cmFudHMpID0+IHtcclxuICAgIHJlc3RhdXJhbnRzLmZvckVhY2gocmVzdGF1cmFudCA9PiB7XHJcbiAgICAgICAgLy8gQWRkIG1hcmtlciB0byB0aGUgbWFwXHJcbiAgICAgICAgY29uc3QgbWFya2VyID0gREJIZWxwZXIubWFwTWFya2VyRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBzZWxmLm1hcCk7XHJcbiAgICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIobWFya2VyLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gbWFya2VyLnVybFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNlbGYubWFya2Vycy5wdXNoKG1hcmtlcik7XHJcbiAgICB9KTtcclxufVxyXG4iXX0=
